<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper
  PUBLIC "-//www.mybatis.org//DTD Mapper 3.0//EN"
  "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="eApplyMessage">
  
	<select id="getInMsgList"   parameterType="model.MessageParam" resultType="model.MessageDto">
		SELECT m.SEQ, m.CONTENT, m.FROM, m.TO, m.SDATE, m.OPEN, m.DEL, m.IMPORTANT, m.DISTINGUISH, c.NAME
		FROM (SELECT * FROM MESSAGE WHERE `TO` =   #{toSeq}) m, C_Member c
		WHERE m.FROM = c.SEQ AND m.DISTINGUISH = 'com' AND m.DEL = 0
		<if test="sKeyword != null and sKeyword !=''">
		AND( m.CONTENT LIKE CONCAT('%', #{sKeyword}, '%') OR  c.NAME = #{sKeyword})
		</if>
		ORDER BY m.SDATE DESC
		LIMIT #{recordCountPerPage, jdbcType=INTEGER} OFFSET #{start, jdbcType=INTEGER}
 	 </select>

 	 <select id="getTotalRecordCount" parameterType="model.MessageParam" resultType="int">
 	 	SELECT COUNT(*)
 	 	FROM (SELECT * FROM MESSAGE WHERE `TO` =   #{toSeq}) m, C_Member c
 	 	WHERE  m.FROM = c.SEQ AND m.DISTINGUISH = 'com' AND m.DEL = 0
		<if test="sKeyword != null and sKeyword !=''">
		 AND( m.CONTENT LIKE CONCAT('%', #{sKeyword}, '%') OR  c.NAME = #{sKeyword})
		</if>
 	 </select>

	<update id="addStar" parameterType="int">
	   UPDATE MESSAGE
	   SET IMPORTANT = 1
	   WHERE SEQ = ${seq}
	
	</update>
	
	<update id="removeStar" parameterType="int">
	   UPDATE MESSAGE
	   SET IMPORTANT = 0
	   WHERE SEQ = ${seq}
	
	</update>
	
	<select id="getMsgDetail" parameterType="int" resultType="model.MessageDto">
		SELECT m.SEQ, m.CONTENT, m.FROM, m.TO, m.SDATE, m.OPEN, m.DEL, m.IMPORTANT, c.NAME
		FROM MESSAGE m, C_Member c
		WHERE m.FROM = c.SEQ AND m.SEQ = ${seq}
		
	</select>
	
	<select id="getSMsgDetail" parameterType="int" resultType="model.MessageDto">
		SELECT m.SEQ, m.CONTENT, m.FROM, m.TO, m.SDATE, m.OPEN, m.DEL, m.IMPORTANT, c.NAME
		FROM MESSAGE m, C_Member c
		WHERE m.TO = c.SEQ AND m.SEQ = ${seq}
		
	</select>
	
	
	
 	 
 	 <select id="getImpoMsgList"   parameterType="model.MessageParam" resultType="model.MessageDto">
		SELECT m.SEQ, m.CONTENT, m.FROM, m.TO, m.SDATE, m.OPEN, m.DEL, m.IMPORTANT, m.DISTINGUISH, c.NAME
		FROM (SELECT * FROM MESSAGE WHERE `TO` =   #{toSeq}) m, C_Member c
		WHERE m.FROM = c.SEQ AND m.IMPORTANT = 1 AND m.DISTINGUISH = 'com' AND m.DEL = 0
		<if test="sKeyword != null and sKeyword !=''">
		AND( m.CONTENT LIKE CONCAT('%', #{sKeyword}, '%') OR  c.NAME = #{sKeyword})
		</if>
		ORDER BY m.SDATE DESC
		LIMIT #{recordCountPerPage, jdbcType=INTEGER} OFFSET #{start, jdbcType=INTEGER}

 	 </select>
 	 
 	 <select id="getImpoCount" parameterType="model.MessageParam" resultType="int">
 	 	SELECT COUNT(*)
 	 	FROM (SELECT * FROM MESSAGE WHERE `TO` =  #{toSeq}) m, C_Member c
 	 	WHERE m.FROM = c.SEQ AND m.IMPORTANT = 1 AND m.DISTINGUISH = 'com' AND m.DEL = 0
		<if test="sKeyword != null and sKeyword !=''">
		 AND( m.CONTENT LIKE CONCAT('%', #{sKeyword}, '%') OR  c.NAME = #{sKeyword})
		</if>
 	 </select>
 	 
 	 <update id="deleteMsg" parameterType="int">
 	 	UPDATE MESSAGE 
 	 	SET DEL = 1
 	 	WHERE SEQ = ${seq}
 	 
 	 </update>
 	 
 	 <select id="getOutMsgList" parameterType="model.MessageParam" resultType="model.MessageDto">
 	 	SELECT m.SEQ, m.CONTENT, m.FROM, m.TO, m.SDATE, m.OPEN, m.DEL, m.IMPORTANT, m.DISTINGUISH, c.NAME
		FROM (SELECT * FROM MESSAGE WHERE `FROM` =  #{toSeq}) m, C_Member c
		WHERE m.TO = c.SEQ AND m.DISTINGUISH = 'mem' AND m.DEL = 0
		<if test="sKeyword != null and sKeyword !=''">
		AND( m.CONTENT LIKE CONCAT('%', #{sKeyword}, '%') OR  c.NAME = #{sKeyword})
		</if>
		ORDER BY m.SDATE DESC
		LIMIT #{recordCountPerPage, jdbcType=INTEGER} OFFSET #{start, jdbcType=INTEGER}
 	 
 	 </select>
 	 
 	 <select id="getSendCount" parameterType="model.MessageParam" resultType="int">
 	 	SELECT COUNT(*)
 	 	FROM (SELECT * FROM MESSAGE WHERE `FROM` =  #{toSeq}) m, C_Member c
 	 	WHERE m.TO = c.SEQ AND m.DISTINGUISH = 'mem' AND m.DEL = 0
		<if test="sKeyword != null and sKeyword !=''">
		 AND( m.CONTENT LIKE CONCAT('%', #{sKeyword}, '%') OR  c.NAME = #{sKeyword})
		</if>
 	 </select>
 	 
 	 <update id="msgOpen" parameterType="int">
 	 	UPDATE MESSAGE
 	 	SET OPEN = 1
 	 	WHERE SEQ = #{seq}
 	 
 	 </update>
 	 
 	 <insert id="sendMsg" parameterType="model.MessageDto">
 	 	INSERT INTO MESSAGE
 	 	VALUES(SEQ, #{content}, #{from}, #{to} , NOW(), 0, 0, 0, "mem")
 	 
 	 </insert>
 	 
 	 <select id="unreadCount" parameterType="int" resultType="int">
 	 	SELECT COUNT(*)
 	 	FROM MESSAGE 
 	 	WHERE `TO` = #{seq} AND OPEN = 0 AND DEL = 0 AND DISTINGUISH = 'com'
 	 </select>
	
	<select id="impoUnreadCount" parameterType="int" resultType="int">
 	 	SELECT COUNT(*)
 	 	FROM MESSAGE 
 	 	WHERE `TO` = #{seq} AND OPEN = 0 AND DEL = 0 AND IMPORTANT = 1 AND DISTINGUISH = 'com'
 	 </select>
 	
 	<select id="getUnreadMsgCount" parameterType="model.MessageParam" resultType="model.MessageDto">
 		SELECT m.SEQ, m.CONTENT, m.FROM, m.TO, m.SDATE, m.OPEN, m.DEL, m.IMPORTANT, m.DISTINGUISH, c.NAME
		FROM (SELECT * FROM MESSAGE WHERE `TO` =  #{toSeq}) m, C_Member c
		WHERE m.FROM = c.SEQ AND m.DISTINGUISH = 'com' AND m.DEL = 0 AND m.OPEN = 0
		<if test="sKeyword != null and sKeyword !=''">
		AND( m.CONTENT LIKE CONCAT('%', #{sKeyword}, '%') OR  c.NAME = #{sKeyword})
		</if>
		ORDER BY m.SDATE DESC
		LIMIT #{recordCountPerPage, jdbcType=INTEGER} OFFSET #{start, jdbcType=INTEGER}
 	
 	</select> 
 	
 	<select id="getImpoUnreadMsgCount" parameterType="model.MessageParam" resultType="model.MessageDto">
 				SELECT m.SEQ, m.CONTENT, m.FROM, m.TO, m.SDATE, m.OPEN, m.DEL, m.IMPORTANT, m.DISTINGUISH, c.NAME
		FROM (SELECT * FROM MESSAGE WHERE `TO` =   #{toSeq}) m, C_Member c
		WHERE m.FROM = c.SEQ AND m.IMPORTANT = 1 AND m.DISTINGUISH = 'com' AND m.DEL = 0 AND m.OPEN = 0
		<if test="sKeyword != null and sKeyword !=''">
		AND( m.CONTENT LIKE CONCAT('%', #{sKeyword}, '%') OR  c.NAME = #{sKeyword})
		</if>
		ORDER BY m.SDATE DESC
		LIMIT #{recordCountPerPage, jdbcType=INTEGER} OFFSET #{start, jdbcType=INTEGER}
 	
 	</select>  
 	 
 	 
  </mapper>